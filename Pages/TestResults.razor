@page "/test-results"
@inject NavigationManager Navigation
@inject TestResultsService ResultsService
@using StudyBuddy.Models
@using StudyBuddy.Services

<PageTitle>Test Results - Study Buddy</PageTitle>

<style>
    .results-container {
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 40px 20px;
    }

    .results-card {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        border-radius: 24px;
        padding: 50px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .results-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .celebration-icon {
        font-size: 4rem;
    }

    .results-title {
        font-size: 2.5rem;
        font-weight: bold;
        color: #2d3748;
        margin: 10px 0;
    }

    .results-subtitle {
        font-size: 1.1rem;
        color: #718096;
    }

    .summary-stats {
        display: flex;
        gap: 20px;
        margin-bottom: 50px;
    }

    .stat-box {
        flex: 1;
        background: #f7fafc;
        border: 2px solid #e2e8f0;
        border-radius: 16px;
        padding: 25px;
        text-align: center;
    }

    .stat-icon {
        font-size: 2rem;
    }

    .stat-value {
        display: block;
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
        margin: 10px 0;
    }

    .stat-label {
        font-size: 0.9rem;
        color: #718096;
    }

    .category-results {
        margin-bottom: 40px;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #2d3748;
        margin-bottom: 25px;
    }

    .category-item {
        background: #f7fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
    }

    .category-top {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
    }

    .cat-emoji {
        font-size: 1.5rem;
    }

    .cat-name {
        flex: 1;
        font-size: 1.1rem;
        font-weight: 600;
        color: #2d3748;
    }

    .cat-points {
        font-size: 1rem;
        font-weight: bold;
        color: #667eea;
        background: white;
        padding: 5px 15px;
        border-radius: 8px;
    }

    .bar-section {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .bar-outer {
        flex: 1;
        height: 30px;
        background: #cbd5e0;
        border-radius: 15px;
        overflow: hidden;
    }

    .bar-inner {
        height: 100%;
        background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);
        transition: width 1s ease;
    }

    .bar-percent {
        font-size: 1rem;
        font-weight: bold;
        color: #2d3748;
        min-width: 50px;
        text-align: right;
    }

    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
    }

    .btn-primary,
    .btn-secondary {
        padding: 16px 35px;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 12px;
        cursor: pointer;
        border: none;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

    .btn-secondary {
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
    }

        .btn-secondary:hover {
            background: #f7fafc;
        }

    .no-results {
        text-align: center;
        padding: 60px 20px;
    }

    .error-icon {
        font-size: 4rem;
    }

    .no-results h2 {
        font-size: 1.8rem;
        color: #2d3748;
        margin: 15px 0;
    }

    .no-results p {
        font-size: 1.1rem;
        color: #718096;
        margin-bottom: 30px;
    }
</style>

<div class="results-container">
    <div class="results-card">
        @if (result != null)
        {
            <div class="results-header">
                <div class="celebration-icon">🎉</div>
                <h1 class="results-title">Test Complete!</h1>
                <p class="results-subtitle">Here's how you did across all categories</p>
            </div>

            <div class="summary-stats">
                <div class="stat-box">
                    <span class="stat-icon">📊</span>
                    <span class="stat-value">@totalPoints</span>
                    <span class="stat-label">Total Points</span>
                </div>
                <div class="stat-box">
                    <span class="stat-icon">⏱️</span>
                    <span class="stat-value">@((int)result.TotalTime.TotalMinutes)m</span>
                    <span class="stat-label">Total Time</span>
                </div>
                <div class="stat-box">
                    <span class="stat-icon">⭐</span>
                    <span class="stat-value">@averagePoints</span>
                    <span class="stat-label">Average/Category</span>
                </div>
            </div>

            <div class="category-results">
                <h2 class="section-title">Performance by Category</h2>

                @foreach (var category in sortedCategories)
                {
                    var percentage = (category.Points / 125.0) * 100;
                    var emoji = category.Points >= 100 ? "🌟" : category.Points >= 70 ? "😊" : category.Points >= 45 ? "🤔" : "📖";

                    <div class="category-item">
                        <div class="category-top">
                            <span class="cat-emoji">@emoji</span>
                            <span class="cat-name">@category.CategoryName</span>
                            <span class="cat-points">@category.Points pts</span>
                        </div>

                        <div class="bar-section">
                            <div class="bar-outer">
                                <div class="bar-inner" style="width: @percentage%"></div>
                            </div>
                            <span class="bar-percent">@((int)percentage)%</span>
                        </div>
                    </div>
                }
            </div>

            <div class="action-buttons">
                <button class="btn-secondary" @onclick="GoHome">
                    🏠 Back to Home
                </button>
                <button class="btn-primary" @onclick="StartStudying">
                    📚 Start Studying
                </button>
            </div>
        }
        else
        {
            <div class="no-results">
                <div class="error-icon">⚠️</div>
                <h2>No Test Results Found</h2>
                <p>Please complete the preliminary test first.</p>
                <button class="btn-primary" @onclick="GoHome">Go to Home</button>
            </div>
        }
    </div>
</div>

@code {
    private PreliminaryTestResult? result;
    private List<CategoryScore> sortedCategories = new();
    private int totalPoints = 0;
    private int averagePoints = 0;

    protected override void OnInitialized()
    {
        result = ResultsService.CurrentResult;

        if (result != null)
        {
            sortedCategories = result.CategoryScores.Values
                .OrderByDescending(c => c.Points)
                .ToList();

            totalPoints = sortedCategories.Sum(c => c.Points);
            averagePoints = sortedCategories.Any() ? totalPoints / sortedCategories.Count : 0;
        }
    }

    private void GoHome()
    {
        Navigation.NavigateTo("/");
    }

    private void StartStudying()
    {
        Console.WriteLine("Starting study mode...");
    }
}