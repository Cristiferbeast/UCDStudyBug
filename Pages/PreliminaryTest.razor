@page "/preliminary-test"
@inject NavigationManager Navigation
@inject PreliminaryTestService TestService
@inject TestResultsService ResultsService
@using StudyBuddy.Models
@using StudyBuddy.Services
@implements IDisposable

<PageTitle>Preliminary Test - Study Buddy</PageTitle>

<div class="test-container">
    <div class="test-card">
        <!-- Header with Progress -->
        <div class="test-header">
            <div class="progress-info">
                <span class="question-counter">Question @(currentQuestionIndex + 1) of @totalQuestions</span>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: @(((currentQuestionIndex + 1) * 100.0 / totalQuestions))%"></div>
                </div>
            </div>
            <div class="timer">
                <span class="timer-icon">⏱️</span>
                <span class="timer-text">@FormatTime(currentQuestionTime)</span>
            </div>
        </div>

        @if (currentQuestion != null)
        {
            <!-- Category Badge -->
            <div class="category-badge">
                @currentQuestion.CategoryName
            </div>

            <!-- Question -->
            <div class="question-section">
                <h2 class="question-text">@currentQuestion.QuestionText</h2>
            </div>

            @if (!showingFeedback)
            {
                <!-- Answer Options (Before Submit) -->
                <div class="options-grid">
                    @for (int i = 0; i < currentQuestion.Options.Count; i++)
                    {
                        var index = i;
                        var isSelected = selectedAnswerIndex == index;
                        var optionClass = isSelected ? "option-button selected" : "option-button";

                        <button class="@optionClass" @onclick="() => SelectAnswer(index)">
                            <span class="option-letter">@GetOptionLetter(index)</span>
                            <span class="option-text">@currentQuestion.Options[index]</span>
                            @if (isSelected)
                            {
                                <span class="checkmark">✓</span>
                            }
                        </button>
                    }
                </div>

                <!-- Submit Button -->
                <div class="button-container">
                    <button class="btn-submit" @onclick="SubmitAnswer" disabled="@(selectedAnswerIndex == null)">
                        Submit Answer
                    </button>
                </div>
            }
            else
            {
                <!-- Feedback Section (After Submit) -->
                <div class="feedback-section @(wasCorrect ? "correct" : "incorrect")">
                    <div class="feedback-icon">
                        @if (wasCorrect)
                        {
                            <span>✅</span>
                        }
                        else if (wasClose)
                        {
                            <span>🟡</span>
                        }
                        else
                        {
                            <span>❌</span>
                        }
                    </div>
                    <div class="feedback-message">
                        @if (wasCorrect)
                        {
                            <h3>Correct!</h3>
                            <p>Great job! You earned <strong>@lastQuestionPoints points</strong></p>
                        }
                        else if (wasClose)
                        {
                            <h3>Close!</h3>
                            <p>You got partial credit: <strong>@lastQuestionPoints points</strong></p>
                            <p class="correct-answer">The correct answer was: <strong>@GetOptionLetter(currentQuestion.CorrectAnswerIndex). @currentQuestion.Options[currentQuestion.CorrectAnswerIndex]</strong></p>
                        }
                        else
                        {
                            <h3>Incorrect</h3>
                            <p>No points earned this time</p>
                            <p class="correct-answer">The correct answer was: <strong>@GetOptionLetter(currentQuestion.CorrectAnswerIndex). @currentQuestion.Options[currentQuestion.CorrectAnswerIndex]</strong></p>
                        }
                    </div>
                </div>

                <!-- Show Selected vs Correct -->
                <div class="answer-comparison">
                    <div class="your-answer">
                        <strong>Your answer:</strong> @GetOptionLetter(selectedAnswerIndex!.Value). @currentQuestion.Options[selectedAnswerIndex!.Value]
                    </div>
                </div>

                <!-- Continue Button -->
                <div class="button-container">
                    <button class="btn-continue" @onclick="ContinueToNext">
                        @if (currentQuestionIndex < totalQuestions - 1)
                        {
                            <text>Next Question →</text>
                        }
                        else
                        {
                            <text>Finish Test ✓</text>
                        }
                    </button>
                </div>
            }
        }
        else
        {
            <!-- Loading state -->
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading question...</p>
            </div>
        }
    </div>
</div>

@code {
    private List<PreliminaryQuestion> allQuestions = new();
    private PreliminaryQuestion? currentQuestion;
    private int currentQuestionIndex = 0;
    private int totalQuestions = 0;
    private int? selectedAnswerIndex = null;

    private System.Timers.Timer? timer;
    private TimeSpan currentQuestionTime = TimeSpan.Zero;
    private DateTime questionStartTime;

    private bool showingFeedback = false;
    private bool wasCorrect = false;
    private bool wasClose = false;
    private int lastQuestionPoints = 0;
    private TimeSpan lastQuestionTime = TimeSpan.Zero;

    private PreliminaryTestResult testResult = new();

    protected override void OnInitialized()
    {
        allQuestions = TestService.GetShuffledQuestions();
        totalQuestions = allQuestions.Count;
        LoadQuestion(0);
        StartTimer();
    }

    private void LoadQuestion(int index)
    {
        if (index >= allQuestions.Count)
        {
            CompleteTest();
            return;
        }

        currentQuestion = allQuestions[index];
        currentQuestionIndex = index;
        selectedAnswerIndex = null;
        showingFeedback = false;
        currentQuestionTime = TimeSpan.Zero;
        questionStartTime = DateTime.Now;
    }

    private void StartTimer()
    {
        timer = new System.Timers.Timer(100);
        timer.Elapsed += (sender, e) =>
        {
            currentQuestionTime = DateTime.Now - questionStartTime;
            InvokeAsync(StateHasChanged);
        };
        timer.Start();
    }

    private void SelectAnswer(int index)
    {
        if (!showingFeedback)
        {
            selectedAnswerIndex = index;
        }
    }

    private void SubmitAnswer()
    {
        if (currentQuestion == null || selectedAnswerIndex == null) return;

        // Stop timer and calculate time
        lastQuestionTime = DateTime.Now - questionStartTime;

        // Determine correctness
        wasCorrect = selectedAnswerIndex == currentQuestion.CorrectAnswerIndex;
        wasClose = currentQuestion.CloseAnswerIndexes.Contains(selectedAnswerIndex.Value);

        // Calculate points
        lastQuestionPoints = TestService.CalculatePoints(lastQuestionTime, wasCorrect, wasClose);
        var result = TestService.DetermineAnswerResult(lastQuestionTime, wasCorrect, wasClose);

        // Store result
        testResult.IndividualQuestionResults.Add(new QuestionResult
        {
            QuestionId = currentQuestion.Id,
            CategoryName = currentQuestion.CategoryName,
            Points = lastQuestionPoints,
            TimeSpent = lastQuestionTime,
            Result = result
        });

        // Show feedback
        showingFeedback = true;
    }

    private void ContinueToNext()
    {
        LoadQuestion(currentQuestionIndex + 1);
    }

    private void CompleteTest()
    {
        timer?.Stop();
        testResult.CompletedAt = DateTime.Now;

        testResult.TotalTime = testResult.IndividualQuestionResults
            .Select(qr => qr.TimeSpent)
            .Aggregate(TimeSpan.Zero, (sum, time) => sum + time);

        testResult.CategoryScores = TestService.CalculateCategoryScores(testResult.IndividualQuestionResults);

        ResultsService.CurrentResult = testResult;

        Navigation.NavigateTo("/test-results");
    }

    private string FormatTime(TimeSpan time)
    {
        if (time.TotalMinutes >= 1)
        {
            return $"{time.Minutes:D2}:{time.Seconds:D2}";
        }
        return $"{time.Seconds:D2}.{time.Milliseconds / 100}s";
    }

    private string GetOptionLetter(int index)
    {
        return ((char)('A' + index)).ToString();
    }

    public void Dispose()
    {
        timer?.Stop();
        timer?.Dispose();
    }
}